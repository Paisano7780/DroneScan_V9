name: Android CI - DJI Drone App with Simulator

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build APKs

    steps:
    - uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build Debug APK
      run: ./gradlew assembleDebug

    - name: Build Debug Test APK
      run: ./gradlew assembleDebugAndroidTest

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug
        path: app/build/outputs/apk/debug/app-debug.apk

    - name: Upload Debug Test APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-androidTest
        path: app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk

  test:
    needs: build
    runs-on: ubuntu-latest
    name: Instrumented Tests on Firebase Test Lab

    steps:
    - uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build Debug APK
      run: ./gradlew assembleDebug

    - name: Build Debug Test APK
      run: ./gradlew assembleDebugAndroidTest

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: Run instrumented tests on Firebase Test Lab
      run: |
        gcloud firebase test android run \
          --type instrumentation \
          --app app/build/outputs/apk/debug/app-debug.apk \
          --test app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk \
          --device model=shiba,version=34,locale=en,orientation=portrait \
          --timeout 10m \
          --results-bucket=gs://dronescan-855ff-test-results \
          --results-dir=instrumented-tests-$(date +%Y%m%d-%H%M%S) \
          --environment-variables coverage=true,coverageFile="/sdcard/coverage.ec" \
          --project=${{ secrets.GCP_PROJECT_ID }} \
          --no-record-video

    - name: Test Summary
      if: always()
      run: |
        echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Instrumented tests completed on Firebase Test Lab" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Configuration:" >> $GITHUB_STEP_SUMMARY
        echo "- **Device:** Pixel 8 (shiba)" >> $GITHUB_STEP_SUMMARY
        echo "- **Android Version:** API 34 (Android 14)" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Type:** Instrumentation with DJI Simulator" >> $GITHUB_STEP_SUMMARY
        echo "- **Timeout:** 10 minutes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â„¹ï¸ **Note:** DJI SDK tests run in simulation mode" >> $GITHUB_STEP_SUMMARY
        echo "â„¹ï¸ Tests verify app stability without physical drone hardware" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š View detailed results in Firebase Test Lab console" >> $GITHUB_STEP_SUMMARY
